<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbie Schedule Generator (Validated)</title>

  <!-- Try jsDelivr first (fastest) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js" defer></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>
<body>
  <input id="file" type="file" accept=".xlsx,.xls" />
  <button id="go">Parse</button>
  <pre id="out"></pre>

  <!-- === MULTI-CDN LOADER === -->
  <script>
  async function loadSheetJS() {
    if (window.XLSX) return;
    const cdns = [
      "https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js",
      "https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js"
    ];
    let lastErr;
    for (const url of cdns) {
      try {
        await new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = url;
          s.async = true;
          s.crossOrigin = "anonymous";
          s.onload = () => (window.XLSX ? resolve() : reject(new Error("XLSX not defined")));
          s.onerror = () => reject(new Error("Failed to load " + url));
          document.head.appendChild(s);
        });
        if (window.XLSX) return;
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error("Failed to load SheetJS from all CDNs");
  }
  </script>

  <!-- === DEMO PARSER === -->
  <script>
  async function parseWorkbookFromFileInput(fileInput) {
    await loadSheetJS();  // ensure SheetJS present

    const file = fileInput.files?.[0];
    if (!file) throw new Error("No file selected");

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const sheet = wb.SheetNames[0];
    const ws = wb.Sheets[sheet];
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

    return aoa; // just return array-of-arrays for demo
  }

  document.getElementById("go").addEventListener("click", async () => {
    const out = document.getElementById("out");
    try {
      const aoa = await parseWorkbookFromFileInput(document.getElementById("file"));
      out.textContent = JSON.stringify(aoa.slice(0,5), null, 2);
    } catch (err) {
      out.textContent = "‚ùå " + err.message;
    }
  });
  </script>
</body>
</html>
