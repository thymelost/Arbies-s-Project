<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbie Schedule Generator (No-Framework)</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- PWA hooks (Step 3) -->
  <link rel="manifest" href="manifest.webmanifest">
  <script>
    // Register a basic service worker to enable offline use after first load
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(err => {
          console.warn('Service worker registration failed:', err);
        });
      });
    }
  </script>

  <style>
    :root {
      --bg: #f7f7f8;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: var(--text); }
    .container { max-width: 820px; padding: 24px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); padding: 18px; margin: 14px 0; }
    label { font-size: 13px; display: block; margin: 0 0 6px; color: var(--muted); }
    input[type="file"], input[type="date"], input[type="text"] { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #fff; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 640px) { .row { grid-template-columns: 1fr 1fr; } }
    .switch { display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--border); border-radius: 14px; padding: 12px 14px; }
    .muted { color: var(--muted); font-size: 12px; }
    .btn { appearance: none; border: none; outline: none; cursor: pointer; padding: 10px 14px; border-radius: 10px; background: var(--accent); color: white; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .status { font-size: 14px; margin-left: 10px; }
    .status.ok { color: var(--success); }
    .status.err { color: var(--danger); }
    .status.muted { color: var(--muted); }
    .footer { color: var(--muted); font-size: 12px; margin-top: 10px; }
    .pill { display: inline-block; background: #eef2ff; color: #3730a3; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbie Schedule Generator <span class="pill">No-Framework</span></h1>
    <noscript style="color:#dc2626">JavaScript is required.</noscript>
    <div class="card">
      <div class="muted" style="margin-bottom:8px">Reads your Excel and creates a two-week schedule. Works on iPad Safari & Windows/Chrome.</div>
      <div class="row">
        <div>
          <label>Upload Excel (.xlsx/.xls)</label>
          <input id="file" type="file" accept=".xlsx,.xls" />
          <div id="fileLabel" class="muted" style="margin-top:6px"></div>
        </div>
        <div>
          <label>Start date (YYYY-MM-DD)</label>
          <input id="date" type="date" />
          <div class="muted" style="margin-top:6px">If no native date picker, enter YYYY-MM-DD.</div>
        </div>
      </div>

      <div class="switch" style="margin-top:14px">
        <div>
          <div style="font-size:13px; font-weight:600">Alphabetize employee names</div>
          <div class="muted">Sort rows by name before scheduling.</div>
        </div>
        <input id="alpha" type="checkbox" />
      </div>

      <div style="display:flex; align-items:center; gap:10px; margin-top:16px">
        <button id="process" class="btn" disabled>Process Schedule</button>
        <div id="status" class="status muted">Ready</div>
      </div>

      <div class="muted" style="margin-top:10px">
        Expected headers (any order, case-insensitive): Employees, Sex, Area, Mon off, Tue Off, Wed Off, Thurs Off, Fri Off, Sat Off, Sun Off
      </div>
    </div>

    <div class="card" style="font-size:14px; color:#374151">
      <div style="font-weight:600; margin-bottom:6px">Notes</div>
      <ul>
        <li>MRR/WRR alternate daily (respecting off-days).</li>
        <li>“Bar 1” starts Outside Bar week 1 → Inside Bars week 2; “Bar 2” is the inverse.</li>
        <li>Unassigned employees rotate through sections with sex-based filtering and a daily rotating priority.</li>
        <li>Download fallback: direct download when supported; otherwise opens the workbook for manual “Share/Save”.</li>
      </ul>
    </div>

    <div class="footer">If you see only the title, your network likely blocked the library download. This file will try multiple CDNs for SheetJS automatically.</div>
  </div>

  <script>
    // --- Dynamic loader for SheetJS from multiple CDNs ---
    (function loadSheetJS(urls, onload, onfail){
      let i = 0;
      function tryNext(){
        if(i >= urls.length){ onfail && onfail(new Error('Failed to load SheetJS')); return; }
        const s = document.createElement('script');
        s.src = urls[i++];
        s.async = true;
        s.onload = onload;
        s.onerror = tryNext;
        document.head.appendChild(s);
      }
      tryNext();
    })([
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'
    ], function(){
      // SheetJS loaded → init app
      initApp();
    }, function(err){
      document.getElementById('status').textContent = 'Error: could not load Excel library';
      document.getElementById('status').className = 'status err';
    });

    // --- Helpers ---
    const $ = (id) => document.getElementById(id);
    const toLower = (v) => typeof v === 'string' ? v.trim().toLowerCase() : '';
    const pad2 = (n) => String(n).padStart(2,'0');
    const fmt = (d) => (d instanceof Date && !isNaN(d)) ? `${d.getFullYear()}-${d.getMonth()+1 < 9 ? '0' : ''}${d.getMonth()+1}-${d.getDate() < 10 ? '0' : ''}${d.getDate()}` : '';
    function addDays(d, n) { const x = new Date(d.getTime()); x.setDate(x.getDate() + n); return x; }
    function nextSundayDate(from = new Date()) { const day = from.getDay(); const delta = (7 - day) % 7; return addDays(from, delta); }
    function setStatus(msg, type) { const el = $('status'); el.textContent = msg; el.className = 'status ' + (type || 'muted'); }

    const WEEK_DAYS = ['Mon off','Tue off','Wed off','Thurs off','Fri off','Sat off','Sun off'];
    const ALL_SECTIONS = [
      'MRR 1','MRR 2','WRR 1','WRR 2',
      'BOH M + Legacy','BOH W + Legacy',
      'M Legacy + Projects','W Legacy + Projects',
      'Section 1','Section 2 + tables','Section 3','Section 4','Section 5',
      'Sports Book','Section 6','Section 7','Section 8','Section 9 + High limit'
    ];
    const MALE_ONLY = ['MRR 1','MRR 2','BOH M + Legacy','M Legacy + Projects'];
    const FEMALE_ONLY = ['WRR 1','WRR 2','BOH W + Legacy','W Legacy + Projects'];

    function initApp(){
      $('date').value = fmt(nextSundayDate());
      $('file').addEventListener('change', onFile);
      $('process').addEventListener('click', handleProcess);
      setStatus('Ready', 'muted');
    }

    function onFile(e) {
      const f = e.target.files && e.target.files[0];
      $('fileLabel').textContent = f ? ('Selected: ' + f.name) : '';
      $('process').disabled = !f;
      setStatus(f ? ('Loaded: ' + f.name) : 'Ready');
    }

    function saveBlob(blob, filename) {
      const supportsDownloadAttr = 'download' in HTMLAnchorElement.prototype;
      if (supportsDownloadAttr) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        return;
      }
      try {
        const reader = new FileReader();
        reader.onloadend = () => {
          const dataUrl = reader.result;
          const win = window.open();
          if (win) { win.document.location = dataUrl; }
          else { window.location = dataUrl; }
        };
        reader.readAsDataURL(blob);
      } catch (e) {
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(() => URL.revokeObjectURL(url), 30000);
      }
    }

    async function parseEmployees(file) {
      const buf = await file.arrayBuffer();
      const wb = XLSX.read(buf, { type: 'array' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      const employees = rows.map((r) => {
        const lowerKeys = {};
        Object.keys(r).forEach(k => lowerKeys[toLower(k)] = k);
        const get = (want) => r[lowerKeys[want]] ?? '';
        return {
          Employee: get('employees'),
          Sex: toLower(get('sex')),
          Area: toLower(get('area')),
          'Mon off': toLower(r[lowerKeys['mon off']] ?? ''),
          'Tue off': toLower(r[lowerKeys['tue off']] ?? ''),
          'Wed off': toLower(r[lowerKeys['wed off']] ?? ''),
          'Thurs off': toLower(r[lowerKeys['thurs off']] ?? ''),
          'Fri off': toLower(r[lowerKeys['fri off']] ?? ''),
          'Sat off': toLower(r[lowerKeys['sat off']] ?? ''),
          'Sun off': toLower(r[lowerKeys['sun off']] ?? ''),
        };
      }).filter(e => String(e.Employee).trim().length > 0);

      return employees;
    }

    function buildSchedule(employees, startDateStr, alphaSort) {
      if (!/^\d{4}-\d{2}-\d{2}$/.test(startDateStr)) throw new Error('Invalid date. Use YYYY-MM-DD.');

      const list = employees.slice();
      if (alphaSort) list.sort((a,b) => String(a.Employee).localeCompare(String(b.Employee)));

      const scheduleUnassigned = {};
      ALL_SECTIONS.forEach(sec => scheduleUnassigned[sec] = Array(14).fill(false));
      const schedule = list.map(e => [e.Employee, '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
      const findRow = (name) => schedule.find(r => r[0] === name);

      // MRR
      const mrr = list.filter(e => e.Area.includes('mrr'));
      mrr.forEach((emp, idx) => {
        const row = findRow(emp.Employee); if (!row) return;
        let sectionIndex = idx % 2;
        for (let i=0;i<14;i++) {
          const sec = ['MRR 1','MRR 2'][sectionIndex];
          row[i+1] = sec;
          scheduleUnassigned[sec][i] = true;
          sectionIndex = 1 - sectionIndex;
        }
        let secIdx = idx % 2;
        for (let i=0;i<14;i++) {
          const dayOffKey = WEEK_DAYS[i % 7];
          if (emp[dayOffKey]) {
            row[i+1] = 'Off';
            const sec = ['MRR 1','MRR 2'][secIdx];
            scheduleUnassigned[sec][i] = false;
          }
          secIdx = 1 - secIdx;
        }
      });

      // WRR
      const wrr = list.filter(e => e.Area.includes('wrr'));
      wrr.forEach((emp, idx) => {
        const row = findRow(emp.Employee); if (!row) return;
        let sectionIndex = idx % 2;
        for (let i=0;i<14;i++) {
          const sec = ['WRR 1','WRR 2'][sectionIndex];
          row[i+1] = sec;
          scheduleUnassigned[sec][i] = true;
          sectionIndex = 1 - sectionIndex;
        }
        let secIdx = idx % 2;
        for (let i=0;i<14;i++) {
          const dayOffKey = WEEK_DAYS[i % 7];
          if (emp[dayOffKey]) {
            row[i+1] = 'Off';
            const sec = ['WRR 1','WRR 2'][secIdx];
            scheduleUnassigned[sec][i] = false;
          }
          secIdx = 1 - secIdx;
        }
      });

      // Unassigned
      const unassigned = list.filter(e => !e.Area);
      const fixed = ALL_SECTIONS.slice(0,7);
      const rotating = ALL_SECTIONS.slice(7);
      const available = unassigned.map((emp, idx) => {
        const k = idx % rotating.length;
        const rotated = rotating.slice(k).concat(rotating.slice(0,k));
        const finals = fixed.concat(rotated);
        const allowed = emp.Sex === 'male'
          ? finals.filter(sec => !FEMALE_ONLY.includes(sec))
          : finals.filter(sec => !MALE_ONLY.includes(sec));
        return { name: emp.Employee, allowed: allowed.slice() };
      });

      const keys = ALL_SECTIONS.slice();
      const fixedKeys = keys.slice(0,7);
      const rotatingKeys = keys.slice(7);

      for (let day=0; day<14; day++) {
        const dayOffKey = WEEK_DAYS[day % 7];
        const k = day % rotatingKeys.length;
        const dayOrder = fixedKeys.concat(rotatingKeys.slice(k).concat(rotatingKeys.slice(0,k)));

        for (let u=0; u<available.length; u++) {
          const name = available[u].name;
          const row = findRow(name);
          const emp = unassigned.find(e => e.Employee === name);
          if (!row || !emp) continue;
          if (emp[dayOffKey]) { row[day+1] = 'Off'; continue; }

          let placed = false;
          for (let j=0; j<dayOrder.length; j++) {
            const sec = dayOrder[j];
            if (!scheduleUnassigned[sec][day]) {
              const idxAllowed = available[u].allowed.indexOf(sec);
              if (idxAllowed !== -1) {
                row[day+1] = sec;
                scheduleUnassigned[sec][day] = true;
                available[u].allowed.splice(idxAllowed, 1);
                placed = true;
                break;
              }
            }
          }
          if (!placed) row[day+1] = row[day+1] || '';
        }
      }

      // Bar 1 / Bar 2
      const bar1 = list.filter(e => e.Area.includes('bar 1'));
      const bar2 = list.filter(e => e.Area.includes('bar 2'));

      bar1.forEach(emp => {
        const row = findRow(emp.Employee); if (!row) return;
        let sectionIndex = 0;
        for (let i=0;i<14;i++) {
          const sec = ['Outside Bar','Inside Bars'][sectionIndex];
          row[i+1] = sec;
          if ((i+1) % 7 === 0) sectionIndex = 1 - sectionIndex;
        }
        for (let i=0;i<14;i++) {
          const dayOffKey = WEEK_DAYS[i % 7];
          if (emp[dayOffKey]) row[i+1] = 'Off';
        }
      });

      bar2.forEach(emp => {
        const row = findRow(emp.Employee); if (!row) return;
        let sectionIndex = 0;
        for (let i=0;i<14;i++) {
          const sec = ['Inside Bars','Outside Bar'][sectionIndex];
          row[i+1] = sec;
          if ((i+1) % 7 === 0) sectionIndex = 1 - sectionIndex;
        }
        for (let i=0;i<14;i++) {
          const dayOffKey = WEEK_DAYS[i % 7];
          if (emp[dayOffKey]) row[i+1] = 'Off';
        }
      });

      const start = new Date(startDateStr);
      const header = ['Employee'];
      for (let i=0;i<14;i++) header.push(fmt(addDays(start, i)));
      return { header, rows: schedule };
    }

    async function handleProcess() {
      const fileInput = $('file');
      const dateInput = $('date');
      const alphaInput = $('alpha');
      const f = fileInput.files && fileInput.files[0];
      if (!f) { setStatus('Select an Excel file first.'); return; }
      if (!/^\d{4}-\d{2}-\d{2}$/.test(dateInput.value)) { setStatus('Invalid date. Use YYYY-MM-DD.'); return; }

      $('process').disabled = true;
      setStatus('Processing...');
      try {
        const employees = await parseEmployees(f);
        if (!employees.length) { setStatus('No employees found – check your headers.'); $('process').disabled = false; return; }
        const result = buildSchedule(employees, dateInput.value, alphaInput.checked);

        const aoa = [result.header].concat(result.rows);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Schedule');
        const out = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
        const blob = new Blob([out], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const base = (f.name || 'schedule').replace(/\.[^.]+$/, '');
        const fname = base + '_schedule_' + $('date').value + '.xlsx';
        saveBlob(blob, fname);
        setStatus('Success: schedule downloaded.', 'ok');
      } catch (e) {
        console.error(e);
        setStatus('Error: ' + (e && e.message ? e.message : e), 'err');
      } finally {
        $('process').disabled = false;
      }
    }
  </script>
</body>
</html>
