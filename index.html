<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arbie Schedule Generator (Validated)</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="manifest" href="manifest.webmanifest">

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root {
      --bg:#f7f7f8; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280;
      --accent:#2563eb; --success:#16a34a; --danger:#dc2626; --warn:#b45309;
      --highlight-bg:#fef3c7; --highlight-border:#d97706;
      --example-bg:#eef2ff; --example-border:#6366f1;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:920px;padding:24px;margin:0 auto}
    h1{font-size:22px;margin:0 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px;margin:14px 0}
    label{font-size:13px;display:block;margin:0 0 6px;color:var(--muted)}
    input[type="file"],input[type="date"]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:14px}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:640px){.row{grid-template-columns:1fr 1fr}}
    .switch{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:14px;padding:12px 14px}
    .muted{color:var(--muted);font-size:12px}
    .btn{appearance:none;border:none;outline:none;cursor:pointer;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;display:inline-flex;align-items:center;gap:8px;font-weight:600}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .status{font-size:14px;margin-left:10px;white-space:pre-line}
    .status.ok{color:var(--success)} .status.err{color:var(--danger)} .status.warn{color:var(--warn)} .status.muted{color:var(--muted)}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;padding:2px 8px;border-radius:999px;font-size:12px}
    #inputGuide{display:block;transition:all .3s ease;background:var(--highlight-bg);border:2px solid var(--highlight-border);border-radius:12px;padding:12px;font-size:13px;color:#111827;margin-top:12px}
    #inputGuide strong{color:var(--highlight-border)}
    #inputGuide code{background:#fff;border:1px dashed var(--highlight-border);padding:2px 4px;border-radius:4px}
    .example{margin-top:10px;background:var(--example-bg);border:2px solid var(--example-border);border-radius:10px;padding:10px}
    .example .title{font-weight:700;color:#3730a3}
    .example pre{margin:6px 0 0;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
    .sticky{position:sticky;top:8px;z-index:2}
  </style>
</head>
<body>
  <div class="container">
    <h1>Arbie Schedule Generator <span class="pill">Validated</span></h1>

    <div class="card">
      <div class="muted" style="margin-bottom:8px">Reads your Excel and creates a two-week schedule.</div>
      <div class="row">
        <div>
          <label>Upload Excel (.xlsx/.xls)</label>
          <input id="file" type="file" accept=".xlsx,.xls" />
        </div>
        <div>
          <label>Start date (YYYY-MM-DD)</label>
          <input id="date" type="date" />
        </div>
      </div>

      <div class="switch" style="margin-top:14px">
        <div>
          <div style="font-size:13px;font-weight:600">Alphabetize employee names</div>
          <div class="muted">Sort rows by name before scheduling.</div>
        </div>
        <input id="alpha" type="checkbox" />
      </div>

      <div style="display:flex;align-items:center;gap:10px;margin-top:16px">
        <button id="process" class="btn" disabled>Process Schedule</button>
        <div id="status" class="status muted">Ready</div>
      </div>
    </div>

    <div class="card" style="font-size:14px;color:#374151">
      <div style="font-weight:600;margin-bottom:6px">Notes</div>
      <ul>
        <li>MRR/WRR alternate daily (respecting off-days).</li>
        <li>“Bar 1” starts Outside Bar week 1 → Inside Bars week 2; “Bar 2” is the inverse.</li>
        <li>Unassigned employees rotate through sections with sex-based filtering and a daily rotating priority.</li>
      </ul>

      <div id="inputGuide" class="sticky">
        <strong>Expected Columns (any order, case-insensitive):</strong><br>
        <em>Employees, Sex, Area, Mon off, Tue Off, Wed Off, Thurs Off, Fri Off, Sat Off, Sun Off</em>.
        <div class="example">
          <div class="title">Example (CSV/Excel view)</div>
          <pre>Employees,Sex,Area,Mon off,Tue Off,Wed Off,Thurs Off,Fri Off,Sat Off,Sun Off
Jane Doe,Female,WRR,,,Wed,,,Sun
John Smith,Male,Bar 1,x,x,,,,,
Ava Brown,Female,MRR,,x,,,x,,</pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Register service worker (network-first) ---
    if ('serviceWorker' in navigator) {
      const swUrl = `./sw.js?v=${encodeURIComponent(document.lastModified)}`;
      navigator.serviceWorker.register(swUrl).catch(console.error);
    }

    const fileEl = document.getElementById('file');
    const dateEl = document.getElementById('date');
    const btn = document.getElementById('process');
    const statusEl = document.getElementById('status');
    const inputGuide = document.getElementById('inputGuide');

    function gate(){ btn.disabled = !(fileEl.files && fileEl.files.length && dateEl.value); }
    fileEl.addEventListener('change', gate);
    dateEl.addEventListener('input', gate);

    // --- Default date = first Sunday (only on first run, unless user changes) ---
    (function setDefaultStartDateToSundayOnce(){
      if (!dateEl) return;
      // store flag in localStorage to prevent resetting after first run
      if (localStorage.getItem('arbieUserSetDate')) return;

      const today = new Date();
      const offset = (7 - today.getDay()) % 7; // 0 if Sunday
      const target = new Date(today);
      target.setDate(today.getDate() + offset);
      const iso = target.toISOString().slice(0,10);
      dateEl.value = iso;

      // if user changes date manually, remember that
      dateEl.addEventListener('input', () => {
        localStorage.setItem('arbieUserSetDate', 'true');
      });
      const evt = new Event('input', { bubbles: true });
      dateEl.dispatchEvent(evt);
    })();

    // ---------- Normalization & validation ----------
    const DAY_KEYS = ["mon","tue","wed","thu","fri","sat","sun"];
    const HEADER_ALIASES = {
      "employees":["employee","employees","name","full name"],
      "sex":["sex","gender"],
      "area":["area","section","assigned area"],
      "mon off":["mon off","monday off","mon_off","mon-off","off mon"],
      "tue off":["tue off","tuesday off","tues off","tue_off","tue-off","off tue"],
      "wed off":["wed off","wednesday off","weds off","wed_off","wed-off","off wed"],
      "thurs off":["thu off","thurs off","thursday off","thu_off","thu-off","off thu","off thurs"],
      "fri off":["fri off","friday off","fri_off","fri-off","off fri"],
      "sat off":["sat off","saturday off","sat_off","sat-off","off sat"],
      "sun off":["sun off","sunday off","sun_off","sun-off","off sun"]
    };
    const REQUIRED_CANONICAL = ["employees","sex","area","mon off","tue off","wed off","thurs off","fri off","sat off","sun off"];
    const norm = s => String(s||"").trim().toLowerCase();

    function buildHeaderMap(rawHeaders){
      const map = {};
      rawHeaders.forEach((h,i)=>{
        const hNorm = norm(h);
        let canonical = null;
        for (const [canon, aliases] of Object.entries(HEADER_ALIASES)){
          if (aliases.includes(hNorm)) { canonical = canon; break; }
        }
        if (!canonical && REQUIRED_CANONICAL.includes(hNorm)) canonical = hNorm;
        if (canonical) map[canonical] = i;
      });
      return map;
    }

    function validateHeaders(rawHeaders){
      const headerMap = buildHeaderMap(rawHeaders);
      const missing = REQUIRED_CANONICAL.filter(k => headerMap[k] == null);
      return { ok: missing.length === 0, missing, headerMap };
    }

    function parseOff(val){
      const s = norm(val);
      if (!s) return false;
      const truths = new Set(["x","off","true","yes","y","1",
        "sun","mon","tue","tues","wed","weds","thu","thur","thurs","fri","sat",
        "sunday","monday","tuesday","wednesday","thursday","friday","saturday"]);
      return truths.has(s);
    }

    function getDayOffMap(row, headerMap){
      const dayOff = {};
      for (const d of DAY_KEYS){
        const col = headerMap[`${d} off`] ?? headerMap[`${d}off`];
        dayOff[d] = parseOff(col != null ? row[col] : "");
      }
      return dayOff;
    }

    async function parseWorkbookFromFileInput(fileInput){
      // Replace with your actual XLSX parser (SheetJS etc.)
      throw new Error("Hook up XLSX parsing here");
    }

    function scheduleTwoWeeks(headers, dataRows, startDate){
      const { headerMap } = validateHeaders(headers);
      const employees = dataRows.map(r => {
        const name = String(r[headerMap["employees"]] ?? "").trim();
        const sex = String(r[headerMap["sex"]] ?? "").trim().toLowerCase();
        const area = String(r[headerMap["area"]] ?? "").trim();
        const dayOff = getDayOffMap(r, headerMap);
        return { name, sex, area, dayOff };
      });
      const out = [];
      for (let i=0;i<14;i++){
        const d = new Date(startDate);
        d.setDate(d.getDate()+i);
        const dayKey = DAY_KEYS[d.getDay()===0 ? 6 : d.getDay()-1];
        const dayAssignments = [];
        for (const emp of employees){
          if (emp.dayOff[dayKey]) continue;
        }
        out.push({ date:d.toISOString().slice(0,10), assignments:dayAssignments });
      }
      return out;
    }

    btn.addEventListener('click', async () => {
      statusEl.className = 'status';
      statusEl.textContent = "Validating headers...";
      btn.disabled = true;

      try{
        const { headers, dataRows } = await parseWorkbookFromFileInput(fileEl);
        const v = validateHeaders(headers);
        if (!v.ok){
          statusEl.classList.add('err');
          statusEl.textContent = `Missing required columns:\n${v.missing.join(", ")}`;
          btn.disabled = false;
          return;
        }
        statusEl.textContent = "Processing...";
        const startDate = new Date(dateEl.value);
        const result = scheduleTwoWeeks(headers, dataRows, startDate);
        inputGuide.style.display = 'none';
        statusEl.classList.add('ok');
        statusEl.textContent = "✅ Schedule generated successfully";
      }catch(e){
        console.error(e);
        statusEl.classList.add('err');
        statusEl.textContent = `❌ Error: ${e.message}`;
      }finally{
        fileEl.value = "";
        dateEl.value = "";
        setTimeout(()=>{ statusEl.className='status muted'; statusEl.textContent='Ready'; btn.disabled=false; }, 1500);
      }
    });
  </script>
</body>
</html>
